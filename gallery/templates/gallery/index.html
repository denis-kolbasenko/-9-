{% load static %}
<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>3D Storage</title>
    <!-- Importmap –¥–ª—è Three.js -->
    <script type="importmap">
      {
        "imports": {
          "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
          "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
      }
    </script>
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ CSS -->
    <link rel="stylesheet" href="{% static 'gallery/style.css' %}" />
  </head>
  <body>
    <!-- –ë–ª–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-success" style="
                background-color: #d4edda;
                color: #155724;
                padding: 15px;
                margin: 20px 0;
                border: 1px solid #c3e6cb;
                border-radius: 6px;
                text-align: center;
                font-weight: 500;
            ">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <!-- –ü–∞–Ω–µ–ª—å –ø–æ–∏—Å–∫–∞ -->
    <div class="toolbar">
        <form action="{% url 'home' %}" method="get" style="display: flex; width: 100%; gap: 10px; align-items: center;">
            <input type="text" name="q" class="search-input" 
                   placeholder="–ù–∞–π—Ç–∏ 3D –º–æ–¥–µ–ª—å..." 
                   value="{{ request.GET.q|default:'' }}">
            <select name="ordering" class="sort-select" onchange="this.form.submit()">
                <option value="new" {% if request.GET.ordering == 'new' %}selected{% endif %}>–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ</option>
                <option value="old" {% if request.GET.ordering == 'old' %}selected{% endif %}>–°–Ω–∞—á–∞–ª–∞ —Å—Ç–∞—Ä—ã–µ</option>
                <option value="name" {% if request.GET.ordering == 'name' %}selected{% endif %}>–ü–æ –∏–º–µ–Ω–∏ (–ê-–Ø)</option>
            </select>
            <select name="days" class="sort-select" onchange="this.form.submit()">
                <option value="">–í—Å–µ –≤—Ä–µ–º—è</option>
                <option value="1" {% if request.GET.days == '1' %}selected{% endif %}>–ó–∞ —Å–µ–≥–æ–¥–Ω—è</option>
                <option value="7" {% if request.GET.days == '7' %}selected{% endif %}>–ó–∞ –Ω–µ–¥–µ–ª—é</option>
                <option value="30" {% if request.GET.days == '30' %}selected{% endif %}>–ó–∞ –º–µ—Å—è—Ü</option>
            </select>
            <button type="submit" class="search-btn">–§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å</button>
            {% if request.GET.q or request.GET.ordering or request.GET.days %}
                <a href="{% url 'home' %}" class="reset-link">‚úñ –°–±—Ä–æ—Å–∏—Ç—å</a>
            {% endif %}
        </form>
    </div>
    
    <header>
      <h1>{{ page_title }}</h1>
      <a href="{% url 'upload' %}" class="btn" style="background-color: #28a745">
        + –ó–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–¥–µ–ª—å
      </a>
    </header>
    
    <main>
      <div class="gallery-grid">
        {% for asset in page_obj %}
        <div class="asset-card">
          <!-- ‚úÖ –ö–ê–†–¢–û–ß–ö–ê –° 3D –ú–û–î–ï–õ–¨–Æ - –∫–Ω–æ–ø–∫–∞ ‚ñ∂ —Å–æ–∑–¥–∞–µ—Ç—Å—è CSS -->
          <div
            class="card-preview js-load-3d model-container"
            id="model-container-{{ asset.id }}"
            data-url="{{ asset.file.url }}"
          >
            <!-- ‚úÖ –ü–£–°–¢–û - –∫–Ω–æ–ø–∫–∞ ‚ñ∂ –ø–æ—è–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ CSS ::before -->
          </div>
          
          <div class="card-info">
            <h3 class="card-title">{{ asset.title }}</h3>
            <div class="card-meta">
              <span>üìÖ {{ asset.created_at|date:"d M Y" }}</span>
              {% if asset.file %}
              <span style="float: right">
                üíæ {{ asset.file.size|filesizeformat }}
              </span>
              {% endif %}
            </div>
            {% if asset.file %}
            <a href="{{ asset.file.url }}" class="btn" download>–°–∫–∞—á–∞—Ç—å .glb</a>
            {% else %}
            <span style="color: red">–§–∞–π–ª –ø–æ—Ç–µ—Ä—è–Ω</span>
            {% endif %}
          </div>
        </div>
        {% empty %}
            {% if request.GET.q %}
                –ü–æ –∑–∞–ø—Ä–æ—Å—É "{{ request.GET.q }}" –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ üò¢
                –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å –∏–ª–∏ <a href="{% url 'home' %}">—Å–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</a>.
            {% else %}
                –ë–∞–∑–∞ –ø—É—Å—Ç–∞
                –ó–∞–≥—Ä—É–∑–∏—Ç–µ –ø–µ—Ä–≤—É—é –º–æ–¥–µ–ª—å!
            {% endif %}
        {% endfor %}
      </div>

      {% if page_obj.paginator.num_pages > 1 %}
      <div class="pagination">
          {% if page_obj.has_previous %}
              <a href="?page=1{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.ordering %}&ordering={{ request.GET.ordering }}{% endif %}{% if request.GET.days %}&days={{ request.GET.days }}{% endif %}">[¬´ –ü–µ—Ä–≤–∞—è]</a>
              <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.ordering %}&ordering={{ request.GET.ordering }}{% endif %}{% if request.GET.days %}&days={{ request.GET.days }}{% endif %}">[–ù–∞–∑–∞–¥]</a>
          {% endif %}
          
          <span class="current">–°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ page_obj.number }} –∏–∑ {{ page_obj.paginator.num_pages }}</span>
          
          {% if page_obj.has_next %}
              <a href="?page={{ page_obj.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.ordering %}&ordering={{ request.GET.ordering }}{% endif %}{% if request.GET.days %}&days={{ request.GET.days }}{% endif %}">[–î–∞–ª–µ–µ]</a>
              <a href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.ordering %}&ordering={{ request.GET.ordering }}{% endif %}{% if request.GET.days %}&days={{ request.GET.days }}{% endif %}">[–ü–æ—Å–ª–µ–¥–Ω—è—è ¬ª]</a>
          {% endif %}
      </div>
      {% endif %}
    </main>
    
    <footer>
      <p>&copy; 2024 Web Structures Course</p>
    </footer>

    <!-- ‚úÖ –ü–û–õ–ù–´–ô 3D VIEWER –í–°–¢–†–û–ï–ù–ù–´–ô –í HTML + –Ø–†–ö–ò–ô –°–í–ï–¢ -->
    <script type="module">
      import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';
      import { GLTFLoader } from 'https://unpkg.com/three@0.160.0/examples/jsm/loaders/GLTFLoader.js';
      import { OrbitControls } from 'https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js';

      console.log('üî• 3D Viewer –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω!');

      // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏
      window.loadModel = function(containerId, modelUrl) {
        console.log('üöÄ=== –ó–ê–ì–†–£–ó–ö–ê –ú–û–î–ï–õ–ò ===', containerId, modelUrl);
        
        const container = document.getElementById(containerId);
        if (!container) {
          console.error('‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω:', containerId);
          return;
        }
        
        container.innerHTML = '';

        // –°—Ü–µ–Ω–∞, –∫–∞–º–µ—Ä–∞, —Ä–µ–Ω–¥–µ—Ä–µ—Ä
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 100);
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        
        renderer.setSize(container.clientWidth, container.clientHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.toneMapping = THREE.NoToneMapping;     // ‚úÖ –û–¢–ö–õ–Æ–ß–ï–ù–û —Å–∂–∞—Ç–∏–µ —è—Ä–∫–æ—Å—Ç–∏
        renderer.toneMappingExposure = 3.0;             // ‚úÖ x3 —è—Ä–∫–æ—Å—Ç—å
        container.appendChild(renderer.domElement);

        // –°–¢–ò–õ–ò –î–õ–Ø CANVAS
        const canvas = renderer.domElement;
        Object.assign(canvas.style, {
          position: 'absolute',
          top: '0px',
          left: '0px',
          width: '100%',
          height: '100%',
          zIndex: '999999',
          pointerEvents: 'all',
          cursor: 'grab',
          touchAction: 'manipulation'
        });

        // OrbitControls - –ò–ù–¢–ï–†–ê–ö–¢–ò–í–ù–û–°–¢–¨!
        const controls = new OrbitControls(camera, canvas);
        controls.enableDamping = true;
        controls.dampingFactor = 0.1;
        controls.enableZoom = true;
        controls.enablePan = false;
        controls.maxPolarAngle = Math.PI / 2.2;

        // üî• –°–£–ü–ï–† –Ø–†–ö–û–ï –û–°–í–ï–©–ï–ù–ò–ï
        const ambientLight = new THREE.AmbientLight(0xffffff, 2.5);        // 250% —è—Ä–∫–æ—Å—Ç–∏
        scene.add(ambientLight);
        const directionalLight = new THREE.DirectionalLight(0xffffff, 5.0); // 500% —è—Ä–∫–æ—Å—Ç–∏
        directionalLight.position.set(10, 10, 5);
        scene.add(directionalLight);
        const fillLight = new THREE.DirectionalLight(0xffffff, 2.0);       // –ó–∞–ø–æ–ª–Ω—è—é—â–∏–π —Å–≤–µ—Ç
        fillLight.position.set(-5, 5, -5);
        scene.add(fillLight);

        // –õ–æ–∞–¥–µ—Ä
        const loaderDiv = document.createElement('div');
        loaderDiv.className = 'loader-overlay';
        loaderDiv.innerHTML = '<div>–ó–∞–≥—Ä—É–∑–∫–∞ 3D...</div><div class="progress-bar"><div class="progress-fill"></div></div>';
        container.appendChild(loaderDiv);
        const progressFill = loaderDiv.querySelector('.progress-fill');

        // –ó–∞–≥—Ä—É–∑–∫–∞ GLB –º–æ–¥–µ–ª–∏
        const loader = new GLTFLoader();
        console.log('üîÑ –ó–∞–≥—Ä—É–∂–∞–µ–º:', modelUrl);
        
        loader.load(
          modelUrl,
          function(gltf) {
            console.log('‚úÖ –ú–û–î–ï–õ–¨ –ó–ê–ì–†–£–ñ–ï–ù–ê!');
            const model = gltf.scene;
            
            // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –º–æ–¥–µ–ª—å
            const box = new THREE.Box3().setFromObject(model);
            const center = box.getCenter(new THREE.Vector3());
            const size = box.getSize(new THREE.Vector3());
            model.position.sub(center);
            
            const maxDim = Math.max(size.x, size.y, size.z);
            const fov = camera.fov * (Math.PI / 180);
            let cameraZ = Math.abs(maxDim / 2 / Math.tan(fov / 2)) * 1.5;
            
            camera.position.set(cameraZ * 0.6, cameraZ * 0.4, cameraZ);
            camera.lookAt(0, 0, 0);
            
            controls.target.set(0, 0, 0);
            controls.update();
            
            scene.add(model);
            loaderDiv.style.opacity = '0';
            setTimeout(() => loaderDiv.remove(), 300);
          },
          function(xhr) {
            if (xhr.lengthComputable) {
              const percent = xhr.loaded / xhr.total * 100;
              progressFill.style.width = percent + '%';
              console.log('üìä –ó–∞–≥—Ä—É–∑–∫–∞: ' + Math.round(percent) + '%');
            }
          },
          function(error) {
            console.error('‚ùå –û–®–ò–ë–ö–ê:', error);
            loaderDiv.innerHTML = '<div style="color:#dc3545;font-size:14px">‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–¥–µ–ª—å<br>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π–ª GLB</div>';
          }
        );

        // –ê–Ω–∏–º–∞—Ü–∏–æ–Ω–Ω—ã–π —Ü–∏–∫–ª
        function animate() {
          requestAnimationFrame(animate);
          controls.update();
          renderer.render(scene, camera);
        }
        animate();

        // Resize –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
        const resizeObserver = new ResizeObserver(() => {
          const width = container.clientWidth;
          const height = container.clientHeight;
          camera.aspect = width / height;
          camera.updateProjectionMatrix();
          renderer.setSize(width, height);
        });
        resizeObserver.observe(container);
      };

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–∫–æ–≤
      document.addEventListener('DOMContentLoaded', function() {
        console.log('üéØ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è 3D –∫–ª–∏–∫–æ–≤...');
        const containers = document.querySelectorAll('.js-load-3d');
        console.log('–ù–∞–π–¥–µ–Ω–æ –∫–∞—Ä—Ç–æ—á–µ–∫:', containers.length);
        
        containers.forEach((container, index) => {
          container.style.cursor = 'pointer';
          container.addEventListener('click', function(e) {
            e.preventDefault();
            if (this.querySelector('canvas')) {
              console.log('‚è≠Ô∏è –£–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞:', this.id);
              return;
            }
            console.log('üî• –ö–õ–ò–ö –ü–û –ö–ê–†–¢–û–ß–ö–ï:', this.id, this.dataset.url);
            window.loadModel(this.id, this.dataset.url);
          });
        });
      });
    </script>
  </body>
</html>
